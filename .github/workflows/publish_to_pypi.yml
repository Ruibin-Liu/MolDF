name: Publish to PyPI on version update

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0 # fetches all history so we can check if version.py changed

    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel twine

    - name: Check version.py for changes
      id: version_changed
      run: |
        git diff --name-only HEAD HEAD~1 | grep -q 'version.py' && echo "::set-output name=version_changed::true" || echo "::set-output name=version_changed::false"

    - name: Publish to PyPI
      if: ${{ steps.version_changed.outputs.version_changed == 'true' }}
      run: |
        python setup.py sdist bdist_wheel
        twine upload dist/*
